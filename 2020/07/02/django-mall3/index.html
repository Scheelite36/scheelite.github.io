<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Django2.2实战积分商城3——后台管理的使用 | 米糠拌饭の日常</title><meta name="description" content="Django2.2实战积分商城3——后台管理的使用"><meta name="keywords" content="Python,Django,实战,JavaScript,JQuery,AJAX"><meta name="author" content="Jwei Gan"><meta name="copyright" content="Jwei Gan"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Django2.2实战积分商城3——后台管理的使用"><meta name="twitter:description" content="Django2.2实战积分商城3——后台管理的使用"><meta name="twitter:image" content="http://cdn.rice-and-bran.site/Django_cover1.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Django2.2实战积分商城3——后台管理的使用"><meta property="og:url" content="http://123.57.158.5/2020/07/02/django-mall3/"><meta property="og:site_name" content="米糠拌饭の日常"><meta property="og:description" content="Django2.2实战积分商城3——后台管理的使用"><meta property="og:image" content="http://cdn.rice-and-bran.site/Django_cover1.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://123.57.158.5/2020/07/02/django-mall3/"><link rel="prev" title="Django使用的部分报错" href="http://123.57.158.5/2020/07/16/django-error/"><link rel="next" title="Python进程同步之共享内存" href="http://123.57.158.5/2020/07/01/python-shared-memory/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://www.rice-and-bran.site","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">44</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#商品用户等管理配置"><span class="toc-number">1.</span> <span class="toc-text">商品用户等管理配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#商品富文本的使用"><span class="toc-number">2.</span> <span class="toc-text">商品富文本的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#商品前台展示"><span class="toc-number">3.</span> <span class="toc-text">商品前台展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#商品标签"><span class="toc-number">4.</span> <span class="toc-text">商品标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#商品详情及购买"><span class="toc-number">5.</span> <span class="toc-text">商品详情及购买</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#订单详情页面"><span class="toc-number">6.</span> <span class="toc-text">订单详情页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加到购物车"><span class="toc-number">7.</span> <span class="toc-text">添加到购物车</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#提交订单"><span class="toc-number">8.</span> <span class="toc-text">提交订单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#订单支付"><span class="toc-number">9.</span> <span class="toc-text">订单支付</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#个人中心及订单列表"><span class="toc-number">10.</span> <span class="toc-text">个人中心及订单列表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#补充"><span class="toc-number">11.</span> <span class="toc-text">补充</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#admin账户的内容编辑"><span class="toc-number">11.1.</span> <span class="toc-text">admin账户的内容编辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#订单提交的bug"><span class="toc-number">11.2.</span> <span class="toc-text">订单提交的bug</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#待解决问题"><span class="toc-number">12.</span> <span class="toc-text">待解决问题</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(http://cdn.rice-and-bran.site/Django_cover1.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">米糠拌饭の日常</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Django2.2实战积分商城3——后台管理的使用</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-07-02 10:02:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-07-02</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-29 18:43:59"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-07-29</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/">实战案例</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><p>该文章是<a href="https://www.imooc.com" target="_blank" rel="noopener">慕课网</a>相关课程的笔记</p>
<p>上一篇文章已经以该积分商城为例，配置了积分商城的后台管理系统，我们继续补充与完善积分商城的功能</p>
<h2 id="商品用户等管理配置"><a href="#商品用户等管理配置" class="headerlink" title="商品用户等管理配置"></a>商品用户等管理配置</h2><p>添加各个模块的模型管理配置</p>
<p>略</p>
<h2 id="商品富文本的使用"><a href="#商品富文本的使用" class="headerlink" title="商品富文本的使用"></a>商品富文本的使用</h2><p>安装配置富文本编辑器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-ckeditor</span><br></pre></td></tr></table></figure>

<p>settings.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSATLLED_APPS = [</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 富文本编辑器</span></span><br><span class="line">    <span class="string">'ckeditor'</span>,</span><br><span class="line">    <span class="string">'ckeditor_uploader'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义富文本编辑器上传的路径</span></span><br><span class="line">CKEDITOR_UPLOAD_PATH = os.path.join(MEDIA_ROOT, <span class="string">'uploads'</span>)</span><br></pre></td></tr></table></figure>

<p>商品的 models.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ckeditor.fields <span class="keyword">import</span> RichTextField</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">""" 商品信息 """</span></span><br><span class="line">    ...</span><br><span class="line">    content = RichTextField(<span class="string">'商品描述'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200703114959036.png"  alt="image-20200703114959036"></p>
<p>此时后端管理的商品信息表中就会自动生成html富文本编辑器，方便商品信息页的修改和后台显示。</p>
<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200702103152611.png"  alt="image-20200702103152611"></p>
<p>可以在pycharm侧边栏的 External Libraries查看包的源码和相关用法，也可以在pypi上查找ckeditor的文档。</p>
<h2 id="商品前台展示"><a href="#商品前台展示" class="headerlink" title="商品前台展示"></a>商品前台展示</h2><p>给商品详情页添加视图和url，用商品uid放在get参数中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re_path(<span class="string">r'^pro/detail/(?P&lt;pk&gt;\S+)/$'</span>,views.pro_info,name=<span class="string">'pro_info'</span>)</span><br></pre></td></tr></table></figure>

<p>views.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pro_info</span><span class="params">(request, pk)</span>:</span></span><br><span class="line">    <span class="string">""" 商品详情 """</span></span><br><span class="line">    pro_obj = get_object_or_404(Product, uid=pk, is_valid=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'pro_info.html'</span>, &#123;</span><br><span class="line">        <span class="string">'pro_obj'</span>:pro_obj,</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>完善商品详情页的HTML代码。导入模板</p>
<p><font size="2.5">先修改页面为继承，缩减代码。通过模板导入商品详情页的商品信息、图片url等。例如详情页的商品展示图，可通过后台管理上传图片，再导入到模板中。</font></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for banner in pro_obj.banners.all %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"swiper-slide"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; banner.img.url &#125;&#125;"</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p><font size="2.5">对于商品详情页我们填入的html代码，通过模板过滤器将它显示出来</font></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pro-detail"</span>&gt;</span></span><br><span class="line">&#123;&#123; pro_obj.content|safe &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在商品列表中加入商品详情页的跳转</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% url 'mall:pro_info' item.uid %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200705150917129.png"  alt="image-20200705150917129"></p>
<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200705150944816.png"  alt="image-20200705150944816"></p>
<h2 id="商品标签"><a href="#商品标签" class="headerlink" title="商品标签"></a>商品标签</h2><p>现在我们要给首页的精选推荐等绑定商品。</p>
<p>首先通过后台添加商品标签，并给相关商品绑定标签</p>
<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200705151635701.png"  alt="image-20200705151635701"></p>
<p>现在需要实现在首页的html中，实现精选推荐、酒水推荐等栏目的链接和跳转。</p>
<p>THML中设置url跳转，同时添加tag筛选参数</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% url 'mall:product_list' %&#125;?tag=jxtj</span><br></pre></td></tr></table></figure>

<p>同时给跳转目标的视图函数中（这里是商品分页的视图）,给其中的分页器定义按标签进行搜索的方法。</p>
<p>为了能使有相关标签的商品能显示，还需要将标签tag参数传入显示商品列表的html页面的ajax函数中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductList</span><span class="params">(ListView)</span>:</span></span><br><span class="line">    <span class="string">""" 使用面向对象的方法实现商品的展示 """</span></span><br><span class="line">    <span class="comment"># 每页放多少条数据</span></span><br><span class="line">    paginate_by = <span class="number">6</span></span><br><span class="line">    <span class="comment"># 模板位置</span></span><br><span class="line">    template_name = <span class="string">'pro_list.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">        query = Q(status=constants.PRODUCT_STATUS_SELL, is_valid=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 按名称搜索</span></span><br><span class="line">        name = self.request.GET.get(<span class="string">'search'</span>, <span class="string">''</span>)</span><br><span class="line">        <span class="keyword">if</span> name:</span><br><span class="line">            query = query &amp; Q(name__icontains=name)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 根据tag标签展示商品</span></span><br><span class="line">        tag = self.request.GET.get(<span class="string">'tag'</span>, <span class="string">''</span>)</span><br><span class="line">        <span class="keyword">if</span> tag:</span><br><span class="line">            <span class="comment"># 进行tags的外键关联查询</span></span><br><span class="line">            query = query &amp; Q(tags__code=tag)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Product.objects.filter(query)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">""" 添加额外的参数 如搜索参数 标签参数 在这里用于传递到页面的js中使用"""</span></span><br><span class="line">        context = super().get_context_data(**kwargs)</span><br><span class="line">        context[<span class="string">'params'</span>] = self.request.GET.dict()</span><br><span class="line">        <span class="keyword">return</span> context</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    url: <span class="string">'&#123;% url '</span>mall:product_load_list<span class="string">' %&#125;'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">    page: page,</span><br><span class="line">    search:<span class="string">'&#123;&#123; params.search|default_if_none:"" &#125;&#125;'</span>,</span><br><span class="line">    tag:<span class="string">'&#123;&#123; params.tag|default_if_none:"" &#125;&#125;'</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200705172454783.png"  alt="image-20200705172454783"></p>
<p>这样就实现了首页精选推荐和酒水专场的入口。接下来还要实现，下方的商品展示</p>
<p>首先需要修改首页HTML代码和视图，将二者的商品列表传入模板。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 精选推荐的首页显示，其他栏目同理</span></span><br><span class="line">jxtj_list = Product.objects.filter(is_valid=<span class="literal">True</span>,</span><br><span class="line">                                   status=constants.PRODUCT_STATUS_SELL,tags__code=<span class="string">'jxtj'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for item in jstj_list %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"swiper-slide"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'mall:pro_info' item.uid %&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; item.img.url &#125;&#125;"</span>/&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200705180007049.png"  alt="image-20200705180007049"></p>
<h2 id="商品详情及购买"><a href="#商品详情及购买" class="headerlink" title="商品详情及购买"></a>商品详情及购买</h2><p>上文配置完了推荐入口与下方的推荐商品。其实配置的是相同内容，而实际上，入口处是需要根据商品分类来进行配置查询</p>
<p>我们继续进行优化，将首页上方入口的查询改为通过商品分类进行查询。步骤同上文类似，修改html页面参数，商品列表视图及商品列表页的ajax函数。</p>
<p>在商品详情视图优化识别登录用户，然后传入用户的地址，在详情页显示用户默认地址</p>
<p>（考虑到有些用户没有填默认地址）在用户模型中添加方法，调用默认地址的方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    <span class="string">""" 用户基本信息表 """</span></span><br><span class="line">    avatar = models.ImageField(upload_to=<span class="string">'avatar'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    integral = models.SmallIntegerField(<span class="string">'用户积分'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    nickname = models.CharField(max_length=<span class="number">32</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    level = models.SmallIntegerField(<span class="string">'用户等级'</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    is_valid = models.BooleanField(<span class="string">'有效性'</span>,default=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'accounts_user'</span></span><br><span class="line">        verbose_name = <span class="string">'用户基本信息'</span></span><br><span class="line">        verbose_name_plural = <span class="string">'用户基本信息'</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">default_address</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">""" 用户默认地址调用 """</span></span><br><span class="line">        addr = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 寻址有效地址</span></span><br><span class="line">        <span class="comment"># 通过地址表的related_name调用，相当于UserAddress.objects.filter(xxx)</span></span><br><span class="line">        addr_list = self.user_address.filter(is_valid=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 查看是否存在默认地址</span></span><br><span class="line">            addr = addr_list.filter(is_default=<span class="literal">True</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 没有默认地址，返回第一个地址</span></span><br><span class="line">                addr = addr_list[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">except</span> IndexError:</span><br><span class="line">                <span class="comment"># 没有地址</span></span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> addr</span><br></pre></td></tr></table></figure>

<p>在商品详情视图中调用该方法，获取地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pro_info</span><span class="params">(request, pk)</span>:</span></span><br><span class="line">    <span class="string">""" 商品详情 """</span></span><br><span class="line">    pro_obj = get_object_or_404(Product, uid=pk, is_valid=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 如果用户登录了，则显示默认地址</span></span><br><span class="line">    <span class="keyword">if</span> request.user.is_authenticated:</span><br><span class="line">        <span class="comment"># 调用默认地址，实际上相当于调用了地址表中一个对象</span></span><br><span class="line">        default_address = request.user.default_address</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'pro_info.html'</span>, &#123;</span><br><span class="line">        <span class="string">'pro_obj'</span>:pro_obj,</span><br><span class="line">        <span class="string">'default_address'</span>:default_address</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>另：property装饰器是为了实现调用属性一样调用方法</p>
<p>商品详情HTML中导入用户地址</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"promotion-message clear"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"promotion-item-text"</span>&gt;</span>&#123;&#123; default_address.get_address_format &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"promotion-item-text"</span>&gt;</span>&#123;&#123; default_address.address &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200706191249866.png"  alt="image-20200706191249866"></p>
<p>成功调用默认地址</p>
<h2 id="订单详情页面"><a href="#订单详情页面" class="headerlink" title="订单详情页面"></a>订单详情页面</h2><p>在mine模块添加订单页视图，通过面向对象的方式实现商品列表。</p>
<p>该订单详情视图继承于DetailView，和ListView一样，也是基于类的视图。DetailView作用是展示对象的详情页面。</p>
<blockquote>
<p>除了从数据库中获取模型列表的数据外，从数据库获取模型的一条记录数据也是常见的需求。比如查看某篇文章的详情，就是从数据库中获取这篇文章的记录然后渲染模板。对于这种类型的需求，Django 提供了一个 DetailView 类视图。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> DetailView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderDetailView</span><span class="params">(DetailView)</span>:</span></span><br><span class="line">   	<span class="string">""" 订单详情 """</span></span><br><span class="line">	model = Order</span><br><span class="line">    <span class="comment"># slug对应url最后的参数，将模型中的sn字段传入url参数进行查询</span></span><br><span class="line">    slug_field = <span class="string">'sn'</span></span><br><span class="line">    slug_url_kwarg = <span class="string">'sn'</span></span><br><span class="line">    template_name = <span class="string">'order_info.html'</span></span><br></pre></td></tr></table></figure>

<p>mine模块的urls.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path</span><br><span class="line"><span class="keyword">from</span> mine.views <span class="keyword">import</span> OrderDetailView</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 订单页面</span></span><br><span class="line">    re_path(<span class="string">r'^order/(?P&lt;sn&gt;\d+)/$'</span>, login_required(OrderDetailView.as_view()), name=<span class="string">'order'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>html页面修改模板继承，detailview默认传递了一个Order模型的对象，叫object。可以通过<code>object.xx</code>调用订单的数据</p>
<p>同时在订单模型中添加一个关联购物车商品的方法，用于调用购物车中的商品数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span><span class="params">(object)</span>:</span></span><br><span class="line">    xxx</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cart</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">""" 获取购物车数据 """</span></span><br><span class="line">        <span class="keyword">return</span> self.cart.exclude(status=constants.ORDER_STATUS_INIT)</span><br></pre></td></tr></table></figure>

<p>HTML中添加模板元素 ，修改地址跳转。同时将支付处修改为提交表单按钮</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'accounts:address_list' %&#125;"</span> <span class="attr">class</span>=<span class="string">"weui-cell_access"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">"address-name"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; object.to_user &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; object.to_phone &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"address-txt"</span>&gt;</span>&#123;&#123; object.to_area &#125;&#125;&#123;&#123; object.to_address &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">&#123;% for item in object.get_cart %&#125;</span><br><span class="line"><span class="comment">&lt;!--with 方法用于改写变量 endwith结束--&gt;</span></span><br><span class="line">&#123;% with product=item.product %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-media-box_appmsg ord-pro-list"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-media-box__hd"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"../../mall/templates/pro_info.html"</span></span></span><br><span class="line"><span class="tag">           &gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"weui-media-box__thumb"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; product.img.url &#125;&#125;"</span> <span class="attr">alt</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">                 /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-media-box__bd"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"weui-media-box__desc"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'mall:pro_info' product.uid %&#125;"</span> <span class="attr">class</span>=<span class="string">"ord-pro-link"</span></span></span><br><span class="line"><span class="tag">               &gt;</span>&#123;&#123; product.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span></span></span><br><span class="line"><span class="tag">                &gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"weui-media-box__desc"</span>&gt;</span></span><br><span class="line">            规格：<span class="tag">&lt;<span class="name">span</span>&gt;</span>红色<span class="tag">&lt;/<span class="name">span</span>&gt;</span>，<span class="tag">&lt;<span class="name">span</span>&gt;</span>23<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"clear mg-t-10"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wy-pro-pri fl"</span>&gt;</span></span><br><span class="line">                ¥<span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"num font-15"</span>&gt;</span>&#123;&#123; product.price &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pro-amount fr"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"font-13"</span>&gt;</span>数量×<span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"name"</span>&gt;</span>&#123;&#123; item.count &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endwith %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200707220959541.png"  alt="image-20200707220959541"></p>
<h2 id="添加到购物车"><a href="#添加到购物车" class="headerlink" title="添加到购物车"></a>添加到购物车</h2><p>商品模型添加 减库存的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(object)</span>:</span></span><br><span class="line">    xxx</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_storage</span><span class="params">(self,count)</span>:</span></span><br><span class="line">        <span class="string">""" 减库存 """</span></span><br><span class="line">        self.remain_count = F(<span class="string">'remain_count'</span>) - abs(count)</span><br><span class="line">        self.save()</span><br><span class="line">        self.refresh_from_db()</span><br></pre></td></tr></table></figure>

<p>给视图中添加加入购物车方法，然后通过js调用该方法。因为涉及到多个模型的调用，需要加入事务机制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="meta">@transaction.atomic</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cart_add</span><span class="params">(request, pro_uid)</span>:</span></span><br><span class="line">    <span class="string">""" 添加商品到购物车 写接口"""</span></span><br><span class="line">    user = request.user</span><br><span class="line">    product = get_object_or_404(Product,uid=pro_uid,is_valid=<span class="literal">True</span>,</span><br><span class="line">                                status=constants.PRODUCT_STATUS_SELL)</span><br><span class="line">    <span class="comment"># 购买数量</span></span><br><span class="line">    count = int(request.GET.get(<span class="string">'count'</span>,<span class="number">1</span>))</span><br><span class="line">    <span class="comment"># 校验库存</span></span><br><span class="line">    <span class="keyword">if</span> product.remain_count &lt; count:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'no'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 减库存</span></span><br><span class="line">    product.update_storage(count)</span><br><span class="line">    <span class="comment"># 生成购物记录</span></span><br><span class="line">    <span class="comment"># 如果已经添加到购物车了，就把购买的数量和价格更新一下</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cart = Cart.objects.get(product=product,user=user,status=constants.ORDER_STATUS_INIT)</span><br><span class="line">        <span class="comment"># 更新价格和数量</span></span><br><span class="line">        count = cart.count+count</span><br><span class="line">        cart.count = count</span><br><span class="line">        cart.amount = count * cart.price</span><br><span class="line">        <span class="comment"># 保存到购物车数据表中</span></span><br><span class="line">        cart.save()</span><br><span class="line">    <span class="keyword">except</span> Cart.DoesNotExist:</span><br><span class="line">        <span class="comment"># 没有加入到过购物车</span></span><br><span class="line">        Cart.objects.create(product=product,user=user,name=product.name,img=product.img,</span><br><span class="line">                            price=product.price,origin_price=product.origin_price,</span><br><span class="line">                            count=count,amount=count * product.price)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure>

<p>给 加入购物车 的标签添加id属性，加入点击事件调用加入购物车的动作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#cart_add'</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $.post(<span class="string">'&#123;% url "mine:cart_add" pro_obj.uid %&#125;'</span>,&#123;</span><br><span class="line">    	count:<span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>碰到的问题：django.urls.exceptions.NoReverseMatch</p>
<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200708211808882.png"  alt="image-20200708211808882"></p>
<p>正则匹配错误，我将url路径商品参数匹配为了数字，实际上应该使用S+</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re_path(<span class="string">r'^cart/(?P&lt;pro_uid&gt;\S+)/$'</span>, views.cart_add, name=<span class="string">'cart_add'</span>),</span><br></pre></td></tr></table></figure>

<p>这样就可以通过商品详情页直接添加到购物车中</p>
<h2 id="提交订单"><a href="#提交订单" class="headerlink" title="提交订单"></a>提交订单</h2><p>添加购物车url，在商品详情页面、首页页脚中添加跳转。</p>
<p>添加购物车视图，提取用户地址快照保存到订单中，同时修改购物车的状态，关联订单。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> messages</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Sum</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, redirect</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mine.models <span class="keyword">import</span> Order, Cart</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> constants</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cart</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 查询购物车中的商品</span></span><br><span class="line">    product_list = request.user.carts.filter(status=constants.ORDER_STATUS_INIT)</span><br><span class="line">    <span class="comment"># 通过聚合函数查询商品总额 然后传入模板</span></span><br><span class="line">    total = product_list.aggregate(Sum(<span class="string">'amount'</span>),sum(<span class="string">'count'</span>))</span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">'POST'</span>:</span><br><span class="line">        <span class="comment"># 提取当前用户地址</span></span><br><span class="line">        default_address = request.user.default_address</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> default_address:</span><br><span class="line">            <span class="comment">#消息通知</span></span><br><span class="line">            messages.warning(request,<span class="string">'请选择地址信息'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'accounts:address_list'</span>)</span><br><span class="line">        order = Order.objects.create(</span><br><span class="line">            user=request.user,</span><br><span class="line">            <span class="comment"># 生成年月日加上随机数的订单编号</span></span><br><span class="line">            sn=datetime.now().strftime(<span class="string">'%Y%m%d%H%M%S%f'</span>)+str(random.randint(<span class="number">1000</span>,<span class="number">9999</span>)),</span><br><span class="line">            buy_amount=total[<span class="string">'amount__sum'</span>],</span><br><span class="line">            buy_count=total[<span class="string">'count__sum'</span>],</span><br><span class="line">            to_user=default_address.receiver,</span><br><span class="line">            to_area=default_address.get_address_format(),</span><br><span class="line">            to_address=default_address.address,</span><br><span class="line">            to_phone=default_address.phone,</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 修改购物车中的状态 改为已提交</span></span><br><span class="line">        <span class="comment"># 将生成的订单关联到购物车</span></span><br><span class="line">        product_list.update(status=constants.ORDER_STATUS_SUBMIT,order=order)</span><br><span class="line">        <span class="comment"># 跳转到订单页</span></span><br><span class="line">        messages.success(request,<span class="string">'下单成功，请支付'</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'mine:order'</span>,order.sn)</span><br><span class="line">    <span class="comment"># 通过聚合函数查询商品总额 然后传入模板</span></span><br><span class="line">    amount = product_list.aggregate(Sum(<span class="string">'amount'</span>))</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'shopcart.html'</span>,&#123;</span><br><span class="line">        <span class="string">'product_list'</span>:product_list,</span><br><span class="line">        <span class="string">'amount'</span>:total[<span class="string">'amount__sum'</span>]</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>对于购物车显示的总额，需要通过聚合函数查询所有商品的总额 ，然后传入购物车模板。其他参数也要响应传入模板</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pro-amount fr"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"Spinner"</span> <span class="attr">data-value</span>=<span class="string">"&#123;&#123; item.count &#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"/static/js/jquery.Spinner.js"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script type="text/</span>javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">  $(function() &#123;</span></span><br><span class="line"><span class="string">    $('.Spinner').Spinner(&#123; value: $('.Spinner').attr('data-value'), len: 3, max: 999 &#125;);</span></span><br><span class="line"><span class="string">  &#125;);</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上是实现调用数据库中的购买数量，传入模板</p>
<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200709223835870.png"  alt="image-20200709223835870"></p>
<p>但是还没有实现底部合计和上面数量的联动，以及购物车添加数量之后导入订单的问题。待后续有时间可以完善。</p>
<p>至此，已经可以实现商品到购物车再到下单页面的流程。</p>
<h2 id="订单支付"><a href="#订单支付" class="headerlink" title="订单支付"></a>订单支付</h2><p>购物车视图中已添加消息通知，将消息通知传入模板。</p>
<p>使用的jQuery weui里的消息toptip消息通知模板，将其加入模板中，或者可以加入公用模板base.html中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> messages %&#125;</span><br><span class="line">&#123;% <span class="keyword">for</span> msg <span class="keyword">in</span> messges %&#125;</span><br><span class="line">$.toptip(<span class="string">'&#123;&#123; msg &#125;&#125;'</span>,<span class="string">'&#123;&#123; msg.tags &#125;&#125;'</span>);</span><br><span class="line"> &#123;% endfor %&#125;</span><br><span class="line"> &#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>新建提交订单的url和视图</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 订单提交视图</span></span><br><span class="line">path(<span class="string">'order_pay/'</span>,views.order_pay,name=<span class="string">'order_pay'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order_pay</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">""" 提交订单 """</span></span><br><span class="line">    user=request.user</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        sn = request.POST.get(<span class="string">'sn'</span>,<span class="literal">None</span>)</span><br><span class="line">        <span class="comment">#查询订单信息</span></span><br><span class="line">        order=user.orders.get(sn=sn)</span><br><span class="line">        <span class="comment"># 总额与积分比较，够了扣除，不够报错</span></span><br><span class="line">        <span class="keyword">if</span> order.buy_amount &gt; user.integral:</span><br><span class="line">            messages.error(request,<span class="string">'积分余额不足'</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'mine:order'</span>,sn=sn)</span><br><span class="line">        user.update_integral(<span class="number">0</span>,order.buy_amount)</span><br><span class="line">        <span class="comment"># 修改订单状态</span></span><br><span class="line">        order.status=constants.ORDER_STATUS_PAID</span><br><span class="line">        order.save()</span><br><span class="line">        <span class="comment"># 修改购物车关联的状态</span></span><br><span class="line">        order.carts.all().update(status=constants.ORDER_STATUS_PAID)</span><br><span class="line">        <span class="comment"># 支付成功消息提示</span></span><br><span class="line">        messages.success(request,<span class="string">'支付成功'</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">'mine:order'</span>,sn=sn)</span><br></pre></td></tr></table></figure>

<p>最后将订单页的表单提交到该url</p>
<h2 id="个人中心及订单列表"><a href="#个人中心及订单列表" class="headerlink" title="个人中心及订单列表"></a>个人中心及订单列表</h2><p>实现商品分类、个人中心模板等 尝试用类视图方式实现。</p>
<p>商品分类url：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 商品分类</span></span><br><span class="line">    path(<span class="string">'classify'</span>, views.ClassifyTemplateView.as_view(),name=<span class="string">'classify'</span>),</span><br></pre></td></tr></table></figure>

<p>views：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> ListView, TemplateView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassifyTemplateView</span><span class="params">(TemplateView)</span>:</span></span><br><span class="line">    <span class="string">""" 商品分类页 """</span></span><br><span class="line">    template_name = <span class="string">'classify.html'</span></span><br></pre></td></tr></table></figure>

<p>个人中心：</p>
<p>个人中心订单页面通过ListView展示，同时通过ajax异步添加订单内容，值得注意的是，订单列表加载内容被单独提取到了另一个order_load.html文件中，且需要在url中指定该模板<code>OrderListView.as_view(template_name=&#39;order_load.html&#39;)</code>，否则无法正常加载订单内容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path, path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mine <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> mine.views <span class="keyword">import</span> OrderDetailView, MineTemplateView, CollectView, OrderListView</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 个人中心</span></span><br><span class="line">    path(<span class="string">''</span>, views.login_required(MineTemplateView.as_view()), name=<span class="string">'mine'</span>),</span><br><span class="line">    <span class="comment"># 订单列表</span></span><br><span class="line">    path(<span class="string">'order_list/'</span>,login_required(OrderListView.as_view()),name=<span class="string">'order_list'</span>),</span><br><span class="line">    <span class="comment"># 订单列表加载</span></span><br><span class="line">    path(<span class="string">'order_load/'</span>,login_required(OrderListView.as_view(template_name=<span class="string">'order_load.html'</span>)),name=<span class="string">'order_load'</span>),</span><br><span class="line">    <span class="comment"># 收藏</span></span><br><span class="line">    path(<span class="string">'collect/'</span>,login_required(CollectView.as_view()),name=<span class="string">'collect'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Sum, Q</span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> DetailView, TemplateView, ListView</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mine.models <span class="keyword">import</span> Order</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> constants</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MineTemplateView</span><span class="params">(TemplateView)</span>:</span></span><br><span class="line">    <span class="string">""" 个人中心详情 """</span></span><br><span class="line">    template_name = <span class="string">'mine.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""传入constants变量"""</span></span><br><span class="line">        context = super().get_context_data(**kwargs)</span><br><span class="line">        context[<span class="string">'constants'</span>] = constants</span><br><span class="line">        <span class="keyword">return</span> context</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderListView</span><span class="params">(ListView)</span>:</span></span><br><span class="line">    <span class="string">""" 订单列表 """</span></span><br><span class="line">    paginate_by = <span class="number">6</span></span><br><span class="line">    template_name = <span class="string">'all_orders.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">""" 添加订单状态进行搜索 """</span></span><br><span class="line">        <span class="comment"># 先查询用户所有订单</span></span><br><span class="line">        order = Order.objects.filter(user=self.request.user)</span><br><span class="line">        query = Q(status=constants.ORDER_STATUS_DELETED)</span><br><span class="line">        status = self.request.GET.get(<span class="string">'status'</span>, <span class="string">''</span>)</span><br><span class="line">        <span class="comment"># 出入订单状态进行查询</span></span><br><span class="line">        <span class="keyword">if</span> status:</span><br><span class="line">            query = Q(status=status)</span><br><span class="line">            <span class="keyword">return</span> order.filter(query)</span><br><span class="line">        <span class="comment"># 如果status传入为空（则查询全部有效订单），返回有效订单</span></span><br><span class="line">        <span class="keyword">return</span> order.exclude(query)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">""" 添加传入模板的参数 """</span></span><br><span class="line">        context = super().get_context_data(**kwargs)</span><br><span class="line">        context[<span class="string">'constants'</span>] = constants</span><br><span class="line">        <span class="comment"># 转换status数据类型，方便在模板中进行比较判断</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            context[<span class="string">'status'</span>] = int(self.request.GET.get(<span class="string">'status'</span>, <span class="string">''</span>))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            context[<span class="string">'status'</span>] = <span class="string">''</span></span><br><span class="line">        <span class="comment"># 找出与订单绑定的购物车，从而找出商品信息传入模板</span></span><br><span class="line">        <span class="comment"># first()方法可以使得self.get_queryset()为空结果集时返回None</span></span><br><span class="line">        context[<span class="string">'cart_list'</span>] = Cart.objects.filter(order=self.get_queryset().first())</span><br><span class="line">        <span class="keyword">return</span> context</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectView</span><span class="params">(TemplateView)</span>:</span></span><br><span class="line">    <span class="string">""" 收藏页 """</span></span><br><span class="line">    template_name = <span class="string">'shoucang.html'</span></span><br></pre></td></tr></table></figure>

<p>修改订单列表页的模板，通过判断订单状态，实现不同的显示</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>全部订单<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block container %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">"wy-header wy-header-fixed"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wy-header-icon-back"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wy-header-title"</span>&gt;</span>订单管理<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-content"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-tab"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">class</span>=<span class="string">"weui-navbar bar-fixed"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">"top:44px; height:44px; background:#fff;"</span></span></span><br><span class="line"><span class="tag">            &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">class</span>=<span class="string">"weui-navbar__item proinfo-tab-tit font-14</span></span></span><br><span class="line"><span class="tag"><span class="string">            &#123;% if status == '' %&#125;weui-bar__item--on&#123;% endif %&#125;"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">href</span>=<span class="string">"&#123;% url 'mine:order_list' %&#125;"</span></span></span><br><span class="line"><span class="tag">                &gt;</span>全部<span class="tag">&lt;/<span class="name">a</span></span></span><br><span class="line"><span class="tag">                &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"weui-navbar__item proinfo-tab-tit font-14</span></span></span><br><span class="line"><span class="tag"><span class="string">            &#123;% if status == constants.ORDER_STATUS_SUBMIT %&#125;weui-bar__item--on&#123;% endif %&#125;"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">href</span>=<span class="string">"&#123;% url 'mine:order_list' %&#125;?status=&#123;&#123; constants.ORDER_STATUS_SUBMIT &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                &gt;</span>待付款<span class="tag">&lt;/<span class="name">a</span></span></span><br><span class="line"><span class="tag">                &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"weui-navbar__item proinfo-tab-tit font-14</span></span></span><br><span class="line"><span class="tag"><span class="string">            &#123;% if status == constants.ORDER_STATUS_PAID %&#125;weui-bar__item--on&#123;% endif %&#125;"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">href</span>=<span class="string">"&#123;% url 'mine:order_list' %&#125;?status=&#123;&#123; constants.ORDER_STATUS_PAID &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                &gt;</span>待发货<span class="tag">&lt;/<span class="name">a</span></span></span><br><span class="line"><span class="tag">                &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"weui-navbar__item proinfo-tab-tit font-14</span></span></span><br><span class="line"><span class="tag"><span class="string">            &#123;% if status == constants.ORDER_STATUS_SENT %&#125;weui-bar__item--on&#123;% endif %&#125;"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">href</span>=<span class="string">"&#123;% url 'mine:order_list' %&#125;?status=&#123;&#123; constants.ORDER_STATUS_SENT &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                &gt;</span>待收货<span class="tag">&lt;/<span class="name">a</span></span></span><br><span class="line"><span class="tag">                &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"weui-navbar__item proinfo-tab-tit font-14</span></span></span><br><span class="line"><span class="tag"><span class="string">            &#123;% if status == constants.ORDER_STATUS_DONE %&#125;weui-bar__item--on&#123;% endif %&#125;"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">href</span>=<span class="string">"&#123;% url 'mine:order_list' %&#125;?status=&#123;&#123; constants.ORDER_STATUS_DONE &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                &gt;</span>待评价<span class="tag">&lt;/<span class="name">a</span></span></span><br><span class="line"><span class="tag">                &gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-tab__bd proinfo-tab-con"</span> <span class="attr">id</span>=<span class="string">'order_list'</span> <span class="attr">style</span>=<span class="string">"padding-top:87px;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block footer %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        $(<span class="built_in">document</span>).on(<span class="string">'click'</span>, <span class="string">'.ords-btn-dele'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            $.confirm(</span></span><br><span class="line"><span class="actionscript">                <span class="string">'您确定要删除此订单吗?'</span>,</span></span><br><span class="line"><span class="actionscript">                <span class="string">'确认删除?'</span>,</span></span><br><span class="line"><span class="actionscript">                <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                    $.toast(<span class="string">'订单已经删除!'</span>);</span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="actionscript">                <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">//取消操作</span></span></span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="javascript">        $(<span class="built_in">document</span>).on(<span class="string">'click'</span>, <span class="string">'.receipt'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            $.alert(<span class="string">'五星好评送蓝豆哦，赶快去评价吧！'</span>, <span class="string">'收货完成！'</span>);</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">/* 封装函数，异步获取订单数据 */</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> loading = <span class="literal">false</span>; <span class="comment">//是否在加载中</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> page = <span class="number">1</span>; <span class="comment">//当前页</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> noMore = <span class="literal">false</span>; <span class="comment">//是否有下一页</span></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">LoadData</span><span class="params">(callback)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (noMore) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="actionscript">            loading = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">            $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">                url: <span class="string">'&#123;% url '</span>mine:order_load<span class="string">' %&#125;'</span>,</span></span><br><span class="line">                &#123;#async: false,#&#125;</span><br><span class="line">                data: &#123;</span><br><span class="line">                    page: page,</span><br><span class="line"><span class="actionscript">                    cosntants: <span class="string">'&#123;&#123; constants &#125;&#125;'</span>,</span></span><br><span class="line"><span class="actionscript">                    status: <span class="string">'&#123;&#123; status &#125;&#125;'</span>,</span></span><br><span class="line"><span class="actionscript">                    cart_list: <span class="string">'&#123;&#123; cart_list &#125;&#125;'</span></span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="actionscript">                <span class="comment">// 调用接口成功后</span></span></span><br><span class="line"><span class="actionscript">                success: <span class="function"><span class="keyword">function</span> <span class="params">(rest)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 添加html片段到内容区</span></span></span><br><span class="line"><span class="javascript">                    $(<span class="string">'#order_list'</span>).append(rest);</span></span><br><span class="line"><span class="actionscript">                    loading = <span class="literal">false</span>;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 如果有回调函数则调用</span></span></span><br><span class="line">                    if (callback) &#123;</span><br><span class="line">                        callback()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="javascript">        $(<span class="built_in">document</span>.body).infinite(<span class="number">200</span>).on(<span class="string">'infinite'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">            if (page <span class="tag">&lt;</span></span><span class="template-variable">&#123;&#123; paginator.num_pages &#125;&#125;</span><span class="xml"><span class="tag">) &#123;</span></span></span></span><br><span class="line">                page++;</span><br><span class="line">                LoadData();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        LoadData();</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>order_load.html:</p>
<p><code>order.get_status_display</code>可以获取status对应文字内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"tab1"</span> <span class="attr">class</span>=<span class="string">"weui-tab__bd-item weui-tab__bd-item--active"</span>&gt;</span></span><br><span class="line">              &#123;% for order in object_list %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-panel weui-panel_access"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-panel__hd"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>单号：&#123;&#123; order.sn &#125;&#125;<span class="tag">&lt;/<span class="name">span</span></span></span><br><span class="line"><span class="tag">                &gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"ord-status-txt-ts fr"</span>&gt;</span></span><br><span class="line">                  &#123;% if status == '' %&#125;&#123;&#123; order.get_status_display &#125;&#125;&#123;% endif %&#125;</span><br><span class="line">                  &#123;% if status == constants.ORDER_STATUS_SUBMIT %&#125;待付款&#123;% endif %&#125;</span><br><span class="line">                  &#123;% if status == constants.ORDER_STATUS_PAID %&#125;待发货&#123;% endif %&#125;</span><br><span class="line">                  &#123;% if status == constants.ORDER_STATUS_SENT %&#125;待收货&#123;% endif %&#125;</span><br><span class="line">                  &#123;% if status == constants.ORDER_STATUS_DONE %&#125;待评价&#123;% endif %&#125;</span><br><span class="line">              <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-media-box__bd  pd-10"</span>&gt;</span></span><br><span class="line">              &#123;% for cart in order.carts.all %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-media-box_appmsg ord-pro-list"</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-media-box__hd"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'mall:pro_info' cart.product.uid %&#125;"</span></span></span><br><span class="line"><span class="tag">                      &gt;</span><span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">class</span>=<span class="string">"weui-media-box__thumb"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">src</span>=<span class="string">"&#123;&#123; cart.img.url &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">alt</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">                    /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-media-box__bd"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"weui-media-box__desc"</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'mall:pro_info' cart.product.uid %&#125;"</span> <span class="attr">class</span>=<span class="string">"ord-pro-link"</span></span></span><br><span class="line"><span class="tag">                        &gt;</span>&#123;&#123; cart.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span></span></span><br><span class="line"><span class="tag">                      &gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"weui-media-box__desc"</span>&gt;</span></span><br><span class="line">                      规格：<span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>，<span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"clear mg-t-10"</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wy-pro-pri fl"</span>&gt;</span></span><br><span class="line">                        ¥<span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"num font-15"</span>&gt;</span>&#123;&#123; cart.price &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pro-amount fr"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"font-13"</span></span></span><br><span class="line"><span class="tag">                          &gt;</span>数量×<span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"name"</span>&gt;</span>&#123;&#123; cart.count &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span></span></span><br><span class="line"><span class="tag">                        &gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              &#123;% endfor %&#125;</span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"ord-statistics"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>共<span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"num"</span>&gt;</span>&#123;&#123; order.carts.all.count &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span>件商品，<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"wy-pro-pri"</span></span></span><br><span class="line"><span class="tag">                  &gt;</span>总金额：¥<span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"num font-15"</span>&gt;</span>&#123;&#123; order.buy_amount &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span></span></span><br><span class="line"><span class="tag">                &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>(含运费<span class="tag">&lt;<span class="name">b</span>&gt;</span>￥0.00<span class="tag">&lt;/<span class="name">b</span>&gt;</span>)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-panel__ft"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-cell weui-cell_access weui-cell_link oder-opt-btnbox"</span>&gt;</span></span><br><span class="line">                    &#123;% if status == constants.ORDER_STATUS_SUBMIT or status == constants.ORDER_STATUS_DONE %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"ords-btn-dele"</span>&gt;</span>删除订单<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                    &#123;% if status == constants.ORDER_STATUS_SUBMIT %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"order_info2.html"</span> <span class="attr">class</span>=<span class="string">"ords-btn-com"</span>&gt;</span>去付款<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                    &#123;% if status == constants.ORDER_STATUS_SENT %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"ords-btn-com receipt"</span>&gt;</span>确认收货<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                    &#123;% if status == constants.ORDER_STATUS_DONE %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"comment.html"</span> <span class="attr">class</span>=<span class="string">"ords-btn-com"</span>&gt;</span>评价<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              &#123;% endfor %&#125;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>给页脚模板添加首页、个人中心、分类、购物车等等跳转，同时相应页面的页脚添加css效果。</p>
<p>引入页脚模板时候加入tab标签，这样页脚就能根据标签显示对应css效果（css特效通过的是jQuery模板class中的weui-bar__item–on显示）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 个人中心模块 --&gt;</span></span><br><span class="line">&#123;% include 'footer.html' with tab='mine' %&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- footer.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'mine:mine' %&#125;"</span> <span class="attr">class</span>=<span class="string">"weui-tabbar__item</span></span></span><br><span class="line"><span class="tag"><span class="string">                                       &#123;% if tab == 'mine'%&#125;weui-bar__item--on&#123;% endif %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-tabbar__icon foot-menu-member"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"weui-tabbar__label"</span>&gt;</span>我的<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在base.html中添加全局的返回事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'.wy-header-icon-back'</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	history.go(<span class="number">-1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>个人中心模板中，实现各个类型订单按钮的跳转，通过添加status参数的方式，视图中通过判断status参数调取订单数据。而订单列表模板中（如上）则通过判断status参数显示不同的内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'mine:order_list' %&#125;?status=&#123;&#123; constants.ORDER_STATUS_SUBMIT &#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"center-ordersModule"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="admin账户的内容编辑"><a href="#admin账户的内容编辑" class="headerlink" title="admin账户的内容编辑"></a>admin账户的内容编辑</h3><p>在admin后台管理中，默认的用户信息编辑中，只显示了三块内容，无法进行其他的用户信息的添加与编辑。</p>
<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200723160132708.png"  alt="image-20200723160132708"></p>
<p>如果要通过后台进行其他用户信息的修改，查看UserAdmin源码后，发现可以通过fieldsets来进行修改。</p>
<p><img src="/" class="lazyload" data-src="/2020/07/02/django-mall3/image-20200723160714972.png"  alt="image-20200723160714972"></p>
<p>比如我们要添加用户积分integral的显示修改，则复制该父类的fieldsets源码到用户admin类中，添加该字段即可。简单粗暴地进行改写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(User)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAdmin</span><span class="params">(UserAdmin)</span>:</span></span><br><span class="line">    <span class="string">""" 用户管理 """</span></span><br><span class="line">    list_display = (<span class="string">'format_username'</span>,<span class="string">'nickname'</span>,<span class="string">'integral'</span>,<span class="string">'is_valid'</span>)</span><br><span class="line">    fieldsets = (</span><br><span class="line">        (<span class="literal">None</span>, &#123;<span class="string">'fields'</span>: (<span class="string">'username'</span>, <span class="string">'password'</span>)&#125;),</span><br><span class="line">        ((<span class="string">'Personal info'</span>), &#123;<span class="string">'fields'</span>: (<span class="string">'first_name'</span>, <span class="string">'last_name'</span>, <span class="string">'email'</span>,<span class="string">'integral'</span>)&#125;),</span><br><span class="line">        ((<span class="string">'Permissions'</span>), &#123;</span><br><span class="line">            <span class="string">'fields'</span>: (<span class="string">'is_active'</span>, <span class="string">'is_staff'</span>, <span class="string">'is_superuser'</span>, <span class="string">'groups'</span>, <span class="string">'user_permissions'</span>),</span><br><span class="line">        &#125;),</span><br><span class="line">        ((<span class="string">'Important dates'</span>), &#123;<span class="string">'fields'</span>: (<span class="string">'last_login'</span>, <span class="string">'date_joined'</span>)&#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">format_username</span><span class="params">(self,obj)</span>:</span></span><br><span class="line">        <span class="string">""" 用户名脱敏处理 """</span></span><br><span class="line">        format_username = obj.username[<span class="number">0</span>:<span class="number">3</span>] + <span class="string">'***'</span></span><br><span class="line">        <span class="keyword">return</span> format_username</span><br><span class="line"></span><br><span class="line">    format_username.short_description = <span class="string">'用户名'</span></span><br><span class="line">    search_list = (<span class="string">'username'</span>,<span class="string">'nickname'</span>)</span><br><span class="line">    actions = [set_valid,set_invalid]</span><br></pre></td></tr></table></figure>

<h3 id="订单提交的bug"><a href="#订单提交的bug" class="headerlink" title="订单提交的bug"></a>订单提交的bug</h3><p>订单提交之后，依然在原始页面，然后点击该页面的支付按钮后会报错无该订单。</p>
<p>解决办法1：给button添加a标签实现跳转</p>
<p>解决方法2：因为支付后 订单属性发生变化，判断订单属性显示不同内容。</p>
<p>订单详细传入constants参数到模板。</p>
<p>在订单的DetailView中传入constants变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderDetailView</span><span class="params">(DetailView)</span>:</span></span><br><span class="line">    <span class="string">""" 订单详情 """</span></span><br><span class="line">    model = Order</span><br><span class="line">    <span class="comment"># 将模型中的sn字段传入url参数进行查询</span></span><br><span class="line">    slug_field = <span class="string">'sn'</span></span><br><span class="line">    slug_url_kwarg = <span class="string">'sn'</span></span><br><span class="line">    template_name = <span class="string">'order_info2.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        context = super().get_context_data(**kwargs)</span><br><span class="line">        context[<span class="string">'constants'</span>] = constants</span><br><span class="line">        <span class="keyword">return</span> context</span><br></pre></td></tr></table></figure>

<p>在html页面中进行判断</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if object.status != constants.ORDER_STATUS_PAID %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mg10-0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"weui-btn weui-btn_primary"</span>&gt;</span>积分支付<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<h2 id="待解决问题"><a href="#待解决问题" class="headerlink" title="待解决问题"></a>待解决问题</h2><p>订单的多次提交</p>
<p>商城收藏页的完善</p>
<p>商品分类页的完善</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Jwei Gan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://123.57.158.5/2020/07/02/django-mall3/">http://123.57.158.5/2020/07/02/django-mall3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://123.57.158.5" target="_blank">米糠拌饭の日常</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/Django/">Django</a><a class="post-meta__tags" href="/tags/%E5%AE%9E%E6%88%98/">实战</a><a class="post-meta__tags" href="/tags/JavaScript/">JavaScript</a><a class="post-meta__tags" href="/tags/JQuery/">JQuery</a><a class="post-meta__tags" href="/tags/AJAX/">AJAX</a></div><div class="post_share"><div class="social-share" data-image="http://cdn.rice-and-bran.site/python.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechatpay.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/07/16/django-error/"><img class="prev_cover lazyload" data-src="http://cdn.rice-and-bran.site/Django_cover1.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Django使用的部分报错</div></div></a></div><div class="next-post pull_right"><a href="/2020/07/01/python-shared-memory/"><img class="next_cover lazyload" data-src="http://cdn.rice-and-bran.site/python.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python进程同步之共享内存</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/06/10/django-mooc-project2/" title="Django2.2实战积分商城2——表单的使用"><img class="relatedPosts_cover lazyload"data-src="http://cdn.rice-and-bran.site/Django_cover1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-06-10</div><div class="relatedPosts_title">Django2.2实战积分商城2——表单的使用</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/09/Django框架入门/" title="Django框架入门"><img class="relatedPosts_cover lazyload"data-src="http://cdn.rice-and-bran.site/Django_cover1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-09</div><div class="relatedPosts_title">Django框架入门</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/12/django-mooc-project/" title="Django2.2实战积分商城1——创建ORM模型"><img class="relatedPosts_cover lazyload"data-src="http://cdn.rice-and-bran.site/Django_cover1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-12</div><div class="relatedPosts_title">Django2.2实战积分商城1——创建ORM模型</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/29/Django安全及维护/" title="Django安全及维护————以积分商城为例"><img class="relatedPosts_cover lazyload"data-src="http://cdn.rice-and-bran.site/Django_cover1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-07-29</div><div class="relatedPosts_title">Django安全及维护————以积分商城为例</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/22/Django对象关系映射-ORM/" title="Django对象关系映射(ORM)"><img class="relatedPosts_cover lazyload"data-src="http://cdn.rice-and-bran.site/Django_cover1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-22</div><div class="relatedPosts_title">Django对象关系映射(ORM)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/06/28/django-admin/" title="Django后台管理系统——以积分商城为例"><img class="relatedPosts_cover lazyload"data-src="http://cdn.rice-and-bran.site/Django_cover1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-06-28</div><div class="relatedPosts_title">Django后台管理系统——以积分商城为例</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTM3NC8yNTg2Ng=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Jwei Gan</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="icp"><a href="http://www.beian.miit.gov.cn/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"/><span>赣ICP备20002874号</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/search/local-search.js"></script><script>if (document.getElementsByClassName('mermaid').length) {
  loadScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js',function () {
    mermaid.initialize({
      theme: 'default',
  })
})
}</script></body></html>